/*
 * Copyright (C) 2013 Red Hat
 * Author: Rob Clark <robdclark@gmail.com>
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 as published by
 * the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 *
 * You should have received a copy of the GNU General Public License along with
 * this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "a3xx_gpu.h"

#define A3XX_INT0_MASK \
	(A3XX_INT0_RBBM_AHB_ERROR |        \
	 A3XX_INT0_RBBM_ATB_BUS_OVERFLOW | \
	 A3XX_INT0_CP_T0_PACKET_IN_IB |    \
	 A3XX_INT0_CP_OPCODE_ERROR |       \
	 A3XX_INT0_CP_RESERVED_BIT_ERROR | \
	 A3XX_INT0_CP_HW_FAULT |           \
	 A3XX_INT0_CP_IB1_INT |            \
	 A3XX_INT0_CP_IB2_INT |            \
	 A3XX_INT0_CP_RB_INT |             \
	 A3XX_INT0_CP_REG_PROTECT_FAULT |  \
	 A3XX_INT0_CP_AHB_ERROR_HALT |     \
	 A3XX_INT0_UCHE_OOB_ACCESS)

static struct platform_device *a3xx_pdev;

/*
pm4                        ME    PFP
PKT3:CP_ME_INIT            y     ? (truncated)
PKT0                       y     n?
PKT3:CP_SET_CONSTANT       y     y
PKT3:CP_INTERRUPT          y     n?
PKT3:CP_EVENT_WRITE        y     n?
PKT3:CP_WAIT_FOR_IDLE      y     n?
PKT3:CP_LOAD_STATE         y     n?
PKT3:CP_SET_BIN_MASK       n     y
PKT3:CP_SET_BIN_SELECT     n     y
PKT3:CP_INVALIDATE_STATE   n     y
PKT3:CP_NOP                n     y
PKT3:CP_REG_RMW            y     n?
PKT3:CP_SET_BIN            y     n?
PKT3:CP_SET_BIN_DATA       y     n?
PKT3:CP_MEM_WRITE          y     n?
PKT3:CP_DRAW_INDX          y     y

n? -> packet is written as-is to MEQ so not sure if
      PFP does anything with it or just blind passthru


PKT3: CP_ME_INIT
RING[107e9000]: c0104800
RING[107e9004]: 000003f7
RING[107e9008]: 00000000
RING[107e900c]: 00000000
RING[107e9010]: 00000000
RING[107e9014]: 00000080
RING[107e9018]: 00000100
RING[107e901c]: 00000180
RING[107e9020]: 00006600
RING[107e9024]: 00000150
RING[107e9028]: 0000014e
RING[107e902c]: 00000154
RING[107e9030]: 00000001
RING[107e9034]: 00000000
RING[107e9038]: 00000000
RING[107e903c]: 00000000
RING[107e9040]: 00000000
RING[107e9044]: 00000000
idle:	MEQ[00]: ........ 00000000 ........ 00000000
idle:	MEQ[04]: 00000000 00000000 00000080 ........
idle:	MEQ[08]: 00000180 00006600 00000150 0000014e
idle:	MEQ[0c]: ........ 00000001 ........ 00000000
idle:	 ME[00]: 00003fff ........ c0104800 000003f7 0000a30c ........ ........ ........
idle:	 ME[08]: ........ ........ ........ 0000019a ........ ........ 084988ca a400ffff
idle:	 ME[10]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[18]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[20]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT0: CP_SCRATCH_REG5
RING[107e9048]: 0000057d
RING[107e904c]: 12345678
idle:	MEQ[00]: ........ ........ ........ 0000057d
idle:	MEQ[04]: 12345678 ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ 0000057d 0000001d ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ 00000005 ........ ........ 024908ca 0000057e
idle:	 ME[10]: 12345678 ........ ........ ........ ........ ........ 00000011 ........
idle:	 ME[18]: ........ 12345678 12345678 ........ 2468acf0 12345678 ........ 12345678
idle:	 ME[20]: ........ 12345678 12345678 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_SET_CONSTANT[CP_SCRATCH_REG6]
RING[107e9050]: c0012d00
RING[107e9054]: ffffe57e
RING[107e9058]: 87654321
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ c0012d00 feffe57e 87654321
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ c0012d00 000000ff 0000057e ........ ........ ........
idle:	 ME[08]: ........ ........ 80000000 40000000 ........ ........ 08498cca ........
idle:	 ME[10]: ........ ........ ........ ........ ........ ........ 0000000c ........
idle:	 ME[18]: 00000003 87654321 87654321 ........ 0eca8642 87654321 ........ 87654321
idle:	 ME[20]: ........ 87654321 87654321 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_INTERRUPT
RING[107e905c]: c0004000
RING[107e9060]: 80000000
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: c0004000 80000000 ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ c0004000 80000000 ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ 00000193 ........ ........ 084988ca 00000061
idle:	 ME[10]: 00008000 ........ ........ ........ ........ ........ 0000003c ........
idle:	 ME[18]: ........ 80000000 80000000 ........ 00000000 80000000 ........ 80000000
idle:	 ME[20]: ........ 80000000 80000000 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_EVENT_WRITE
RING[107e9064]: c0004600
RING[107e9068]: 00000007
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ c0004600 00000007
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ c0004600 00000007 ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ 0000002e ........ ........ 08498cca 000021fa
idle:	 ME[10]: 00000007 ........ ........ ........ ........ ........ ........ ........
idle:	 ME[18]: 00000001 00000007 00000007 ........ 0000000e 00000007 ........ 00000007
idle:	 ME[20]: ........ 00000007 00000007 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_WAIT_FOR_IDLE
RING[107e906c]: c0002600
RING[107e9070]: 00000000
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: c0002600 00000000 ........ ........
idle:	 ME[00]: ........ ........ c0002600 00000005 ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ 0000002a ........ ........ 084988ca 000001f6
idle:	 ME[10]: 00000000 ........ ........ ........ ........ ........ ........ ........
idle:	 ME[18]: ........ 00000000 00000000 ........ 00000000 00000000 ........ 00000000
idle:	 ME[20]: ........ 00000000 00000000 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_LOAD_STATE
RING[107e9074]: c0033000
RING[107e9078]: 00600000
RING[107e907c]: 00000001
RING[107e9080]: 34567890
RING[107e9084]: 09876543
idle:	MEQ[00]: 00000001 34567890 09876543 ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ c0033000 00600000
idle:	 ME[00]: ........ ........ c0033000 00000039 00000001 ........ ........ 0000a308
idle:	 ME[08]: ........ ........ ........ 0000007c ........ ........ 08498cca 0000a308
idle:	 ME[10]: 09876543 ........ ........ ........ ........ ........ 00000015 ........
idle:	 ME[18]: ........ 09876543 09876543 ........ 130eca86 09876543 ........ 09876543
idle:	 ME[20]: ........ 09876543 09876543 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_SET_BIN_MASK
RING[107e9088]: c0015000
RING[107e908c]: 45678900
RING[107e9090]: 10987650
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[10]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[18]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[20]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_SET_BIN_SELECT
RING[107e9094]: c0015100
RING[107e9098]: 55678900
RING[107e909c]: 20987650
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[10]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[18]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[20]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_INVALIDATE_STATE
RING[107e90a0]: c0003b00
RING[107e90a4]: 00007fff
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[10]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[18]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[20]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_NOP
RING[107e90a8]: c0001000
RING[107e90ac]: 23232323
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[10]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[18]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[20]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_REG_RMW[REG_AXXX_CP_SCRATCH_REG6]
RING[107e90b0]: c0022100
RING[107e90b4]: 0000057e
RING[107e90b8]: 56565656
RING[107e90bc]: 98989898
idle:	MEQ[00]: ........ ........ ........ c0022100
idle:	MEQ[04]: 0000057e 56565656 98989898 ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ c0022100 0000057e 00000000 ........ ........ 56565656
idle:	 ME[08]: 98989898 ........ 00000000 00000061 ........ ........ 084988ca 0000057f
idle:	 ME[10]: 98989898 ........ ........ ........ ........ ........ 00000002 ........
idle:	 ME[18]: 00000003 98989898 98989898 ........ 31313130 98989898 ........ 98989898
idle:	 ME[20]: ........ 98989898 98989898 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_SET_BIN
RING[107e90c0]: c0024c00
RING[107e90c4]: 00000000
RING[107e90c8]: 018002e0
RING[107e90cc]: 04000440
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ c0024c00
idle:	MEQ[08]: 00000000 018002e0 04000440 ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	 ME[00]: 00000000 ........ 00000002 00000019 ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ 0000025e ........ ........ 024918ca ........
idle:	 ME[10]: ........ ........ ........ ........ ........ ........ 0000003d ........
idle:	 ME[18]: 00000001 04000440 04000440 ........ 08000880 04000440 ........ 04000440
idle:	 ME[20]: ........ 04000440 04000440 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_SET_BIN_DATA
RING[107e90d0]: c0012f00
RING[107e90d4]: 11223300
RING[107e90d8]: 44444400
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ c0012f00
idle:	MEQ[0c]: 11223300 44444400 ........ ........
idle:	 ME[00]: 00003fff ........ 11223300 00000007 ........ 44444400 ........ ........
idle:	 ME[08]: ........ ........ ........ 00000256 ........ ........ 02498aca 000001f6
idle:	 ME[10]: 00000000 ........ ........ ........ ........ ........ 0000000d ........
idle:	 ME[18]: ........ 44444400 44444400 ........ 88888800 44444400 ........ 44444400
idle:	 ME[20]: ........ 44444400 44444400 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_MEM_WRITE
RING[107e90dc]: c0013d00
RING[107e90e0]: 107f1004
RING[107e90e4]: 11221122
idle:	MEQ[00]: 11221122 ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ c0013d00 107f1004
idle:	 ME[00]: ........ ........ c0013d00 0000000b ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ 0000013d ........ ........ 084988ca 0000860e
idle:	 ME[10]: 11221122 ........ ........ ........ ........ ........ 00000000 ........
idle:	 ME[18]: ........ 11221122 11221122 ........ 22442244 11221122 ........ 11221122
idle:	 ME[20]: ........ 11221122 11221122 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_DRAW_INDX
RING[107e90e8]: c0022200
RING[107e90ec]: 00000000
RING[107e90f0]: 00004088
RING[107e90f4]: 00000000
idle:	MEQ[00]: ........ c0022200 00004088 ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	 ME[00]: 00000001 ........ c0022200 00000004 00004088 ........ ........ ........
idle:	 ME[08]: ........ ........ ........ 00000014 ........ ........ ........ 000021fd
idle:	 ME[10]: 00004088 ........ ........ ........ ........ ........ 0000000c ........
idle:	 ME[18]: ........ 00004088 00004088 ........ 00008110 00004088 ........ 00004088
idle:	 ME[20]: ........ 00004088 00004088 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

------------------------------------------
PKT3: CP_ME_INIT
RING[107e9000]: c0104800
RING[107e9004]: 000003f7
RING[107e9008]: 00000000
RING[107e900c]: 00000000
RING[107e9010]: 00000000
RING[107e9014]: 00000080
RING[107e9018]: 00000100
RING[107e901c]: 00000180
RING[107e9020]: 00006600
RING[107e9024]: 00000150
RING[107e9028]: 0000014e
RING[107e902c]: 00000154
RING[107e9030]: 00000001
RING[107e9034]: 00000000
RING[107e9038]: 00000000
RING[107e903c]: 00000000
RING[107e9040]: 00000000
RING[107e9044]: 00000000
pre:	MEQ[00]: 00000000 00000002 00000000 20020000
pre:	MEQ[04]: 00002000 c0200400 00001080 00000100
pre:	MEQ[08]: 28000180 00004608 00000510 10020106
pre:	MEQ[0c]: 00000154 00000000 00000000 02020000
pre:	ROQ[00]: 250b2480 00084904 80c00748 4a89020c 21100000 08008000 8a427800 1c1388c0
pre:	ROQ[08]: 10182450 21000000 00010000 42200008 00306660 e8837900 10080d08 08987c4a
pre:	PFP[00]: 00000000 00000000 00000000 00000000
pre:	PFP[04]: 00000000 00000000 00000000 00000000
pre:	PFP[08]: 00000000 00000000 00000000 00000000
pre:	PFP[0c]: 00000000 80000000 00000000 00000000
pre:	PFP[10]: 00000000 00000000 00000000 00000000
pre:	 ME[00]: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
pre:	 ME[08]: 00000000 00000000 00000000 00000000 00000000 00000000 024918ca 00000000
pre:	 ME[10]: 00000000 00000001 00000000 003ff036 c0200400 00000000 0000003c 00000000
pre:	 ME[18]: 00000001 00000000 00000000 00000000 00000000 00000000 00000000 00000000
pre:	 ME[20]: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
pre:	 ME[28]: 00000000 00000000 00000000 00000000 xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
idle:	MEQ[00]: ........ 00000000 ........ 00000000
idle:	MEQ[04]: 00000000 00000000 00000080 ........
idle:	MEQ[08]: 00000180 00006600 00000150 0000014e
idle:	MEQ[0c]: ........ 00000001 ........ 00000000
idle:	ROQ[00]: 00000000 00000000 00000000 00000000 00000000 00000080 00000100 00000180
idle:	ROQ[08]: 00006600 00000150 0000014e 00000154 00000001 00000000 00000000 00000000
idle:	PFP[00]: ........ ........ ........ ........
idle:	PFP[04]: ........ ........ ........ ........
idle:	PFP[08]: ........ ........ ........ ........
idle:	PFP[0c]: ........ ........ ........ ........
idle:	PFP[10]: ........ ........ ........ ........
idle:	 ME[00]: 00003fff ........ c0104800 000003f7 0000a30c ........ ........ ........
idle:	 ME[08]: ........ ........ ........ 0000019a ........ ........ 084988ca a400ffff
idle:	 ME[10]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[18]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[20]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT0: CP_SCRATCH_REG5
RING[107e9048]: 0000057d
RING[107e904c]: 12345678
pre:	MEQ[00]: 00000000 00000000 00000000 00000000
pre:	MEQ[04]: 00000000 00000000 00000080 00000100
pre:	MEQ[08]: 00000180 00006600 00000150 0000014e
pre:	MEQ[0c]: 00000154 00000001 00000000 00000000
pre:	ROQ[00]: 00000000 00000000 00000000 00000000 00000000 00000080 00000100 00000180
pre:	ROQ[08]: 00006600 00000150 0000014e 00000154 00000001 00000000 00000000 00000000
pre:	PFP[00]: 00000000 00000000 00000000 00000000
pre:	PFP[04]: 00000000 00000000 00000000 00000000
pre:	PFP[08]: 00000000 00000000 00000000 00000000
pre:	PFP[0c]: 00000000 80000000 00000000 00000000
pre:	PFP[10]: 00000000 00000000 00000000 00000000
pre:	 ME[00]: 00003fff 00000000 c0104800 000003f7 0000a30c 00000000 00000000 00000000
pre:	 ME[08]: 00000000 00000000 00000000 0000019a 00000000 00000000 084988ca a400ffff
pre:	 ME[10]: 00000000 00000001 00000000 003ff036 c0200400 00000000 0000003c 00000000
pre:	 ME[18]: 00000001 00000000 00000000 00000000 00000000 00000000 00000000 00000000
pre:	 ME[20]: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
pre:	 ME[28]: 00000000 00000000 00000000 00000000 xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
idle:	MEQ[00]: ........ ........ ........ 0000057d
idle:	MEQ[04]: 12345678 ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	ROQ[00]: ........ ........ ........ ........ ........ 00000000 0000057d 12345678
idle:	ROQ[08]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	PFP[00]: ........ ........ ........ ........
idle:	PFP[04]: ........ ........ ........ ........
idle:	PFP[08]: ........ ........ ........ ........
idle:	PFP[0c]: ........ ........ ........ ........
idle:	PFP[10]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ 0000057d 0000001d ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ 00000005 ........ ........ 024908ca 0000057e
idle:	 ME[10]: 12345678 ........ ........ ........ ........ ........ 00000011 ........
idle:	 ME[18]: ........ 12345678 12345678 ........ 2468acf0 12345678 ........ 12345678
idle:	 ME[20]: ........ 12345678 12345678 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_SET_CONSTANT[CP_SCRATCH_REG6]
RING[107e9050]: c0012d00
RING[107e9054]: ffffe57e
RING[107e9058]: 87654321
pre:	MEQ[00]: 00000000 00000000 00000000 0000057d
pre:	MEQ[04]: 12345678 00000000 00000080 00000100
pre:	MEQ[08]: 00000180 00006600 00000150 0000014e
pre:	MEQ[0c]: 00000154 00000001 00000000 00000000
pre:	ROQ[00]: 00000000 00000000 00000000 00000000 00000000 00000000 0000057d 12345678
pre:	ROQ[08]: 00006600 00000150 0000014e 00000154 00000001 00000000 00000000 00000000
pre:	PFP[00]: 00000000 00000000 00000000 00000000
pre:	PFP[04]: 00000000 00000000 00000000 00000000
pre:	PFP[08]: 00000000 00000000 00000000 00000000
pre:	PFP[0c]: 00000000 80000000 00000000 00000000
pre:	PFP[10]: 00000000 00000000 00000000 00000000
pre:	 ME[00]: 00003fff 00000000 0000057d 0000001d 0000a30c 00000000 00000000 00000000
pre:	 ME[08]: 00000000 00000000 00000000 00000005 00000000 00000000 024908ca 0000057e
pre:	 ME[10]: 12345678 00000001 00000000 003ff036 c0200400 00000000 00000011 00000000
pre:	 ME[18]: 00000001 12345678 12345678 00000000 2468acf0 12345678 00000000 12345678
pre:	 ME[20]: 00000000 12345678 12345678 00000000 00000000 00000000 00000000 00000000
pre:	 ME[28]: 00000000 00000000 00000000 00000000 xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ c0012d00 feffe57e 87654321
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	ROQ[00]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	ROQ[08]: c0012d00 ffffe57e 87654321 00000000 ........ ........ ........ ........
idle:	PFP[00]: ........ ........ ........ ........
idle:	PFP[04]: ........ ........ ........ ........
idle:	PFP[08]: ........ ........ ........ ........
idle:	PFP[0c]: ........ ........ ........ ........
idle:	PFP[10]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ c0012d00 000000ff 0000057e ........ ........ ........
idle:	 ME[08]: ........ ........ 80000000 40000000 ........ ........ 08498cca ........
idle:	 ME[10]: ........ ........ ........ ........ ........ ........ 0000000c ........
idle:	 ME[18]: 00000003 87654321 87654321 ........ 0eca8642 87654321 ........ 87654321
idle:	 ME[20]: ........ 87654321 87654321 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_INTERRUPT
RING[107e905c]: c0004000
RING[107e9060]: 80000000
pre:	MEQ[00]: 00000000 00000000 00000000 0000057d
pre:	MEQ[04]: 12345678 c0012d00 feffe57e 87654321
pre:	MEQ[08]: 00000180 00006600 00000150 0000014e
pre:	MEQ[0c]: 00000154 00000001 00000000 00000000
pre:	ROQ[00]: 00000000 00000000 00000000 00000000 00000000 00000000 0000057d 12345678
pre:	ROQ[08]: c0012d00 ffffe57e 87654321 00000000 00000001 00000000 00000000 00000000
pre:	PFP[00]: 00000000 00000000 00000000 00000000
pre:	PFP[04]: 00000000 00000000 00000000 00000000
pre:	PFP[08]: 00000000 00000000 00000000 00000000
pre:	PFP[0c]: 00000000 80000000 00000000 00000000
pre:	PFP[10]: 00000000 00000000 00000000 00000000
pre:	 ME[00]: 00003fff 00000000 c0012d00 000000ff 0000057e 00000000 00000000 00000000
pre:	 ME[08]: 00000000 00000000 80000000 40000000 00000000 00000000 08498cca 0000057e
pre:	 ME[10]: 12345678 00000001 00000000 003ff036 c0200400 00000000 0000000c 00000000
pre:	 ME[18]: 00000003 87654321 87654321 00000000 0eca8642 87654321 00000000 87654321
pre:	 ME[20]: 00000000 87654321 87654321 00000000 00000000 00000000 00000000 00000000
pre:	 ME[28]: 00000000 00000000 00000000 00000000 xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: c0004000 80000000 ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	ROQ[00]: 80000000 ........ ........ ........ ........ ........ ........ ........
idle:	ROQ[08]: ........ ........ ........ ........ c0012d00 ffffe57e 87654321 c0004000
idle:	PFP[00]: ........ ........ ........ ........
idle:	PFP[04]: ........ ........ ........ ........
idle:	PFP[08]: ........ ........ ........ ........
idle:	PFP[0c]: ........ ........ ........ ........
idle:	PFP[10]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ c0004000 80000000 ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ 00000193 ........ ........ 084988ca 00000061
idle:	 ME[10]: 00008000 ........ ........ ........ ........ ........ 0000003c ........
idle:	 ME[18]: ........ 80000000 80000000 ........ 00000000 80000000 ........ 80000000
idle:	 ME[20]: ........ 80000000 80000000 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_EVENT_WRITE
RING[107e9064]: c0004600
RING[107e9068]: 00000007
pre:	MEQ[00]: 00000000 00000000 00000000 0000057d
pre:	MEQ[04]: 12345678 c0012d00 feffe57e 87654321
pre:	MEQ[08]: c0004000 80000000 00000150 0000014e
pre:	MEQ[0c]: 00000154 00000001 00000000 00000000
pre:	ROQ[00]: 80000000 00000000 00000000 00000000 00000000 00000000 0000057d 12345678
pre:	ROQ[08]: c0012d00 ffffe57e 87654321 00000000 c0012d00 ffffe57e 87654321 c0004000
pre:	PFP[00]: 00000000 00000000 00000000 00000000
pre:	PFP[04]: 00000000 00000000 00000000 00000000
pre:	PFP[08]: 00000000 00000000 00000000 00000000
pre:	PFP[0c]: 00000000 80000000 00000000 00000000
pre:	PFP[10]: 00000000 00000000 00000000 00000000
pre:	 ME[00]: 00003fff 00000000 c0004000 80000000 0000057e 00000000 00000000 00000000
pre:	 ME[08]: 00000000 00000000 80000000 00000193 00000000 00000000 084988ca 00000061
pre:	 ME[10]: 00008000 00000001 00000000 003ff036 c0200400 00000000 0000003c 00000000
pre:	 ME[18]: 00000003 80000000 80000000 00000000 00000000 80000000 00000000 80000000
pre:	 ME[20]: 00000000 80000000 80000000 00000000 00000000 00000000 00000000 00000000
pre:	 ME[28]: 00000000 00000000 00000000 00000000 xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ c0004600 00000007
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	ROQ[00]: ........ ........ ........ ........ 80000000 c0004600 00000007 00000000
idle:	ROQ[08]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	PFP[00]: ........ ........ ........ ........
idle:	PFP[04]: ........ ........ ........ ........
idle:	PFP[08]: ........ ........ ........ ........
idle:	PFP[0c]: ........ ........ ........ ........
idle:	PFP[10]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ c0004600 00000007 ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ 0000002e ........ ........ 08498cca 000021fa
idle:	 ME[10]: 00000007 ........ ........ ........ ........ ........ ........ ........
idle:	 ME[18]: 00000001 00000007 00000007 ........ 0000000e 00000007 ........ 00000007
idle:	 ME[20]: ........ 00000007 00000007 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_WAIT_FOR_IDLE
RING[107e906c]: c0002600
RING[107e9070]: 00000000
pre:	MEQ[00]: 00000000 00000000 00000000 0000057d
pre:	MEQ[04]: 12345678 c0012d00 feffe57e 87654321
pre:	MEQ[08]: c0004000 80000000 c0004600 00000007
pre:	MEQ[0c]: 00000154 00000001 00000000 00000000
pre:	ROQ[00]: 80000000 00000000 00000000 00000000 80000000 c0004600 00000007 00000000
pre:	ROQ[08]: c0012d00 ffffe57e 87654321 00000000 c0012d00 ffffe57e 87654321 c0004000
pre:	PFP[00]: 00000000 00000000 00000000 00000000
pre:	PFP[04]: 00000000 00000000 00000000 00000000
pre:	PFP[08]: 00000000 00000000 00000000 00000000
pre:	PFP[0c]: 00000000 80000000 00000000 00000000
pre:	PFP[10]: 00000000 00000000 00000000 00000000
pre:	 ME[00]: 00003fff 00000000 c0004600 00000007 0000057e 00000000 00000000 00000000
pre:	 ME[08]: 00000000 00000000 80000000 0000002e 00000000 00000000 08498cca 000021fa
pre:	 ME[10]: 00000007 00000001 00000000 003ff036 c0200400 00000000 0000003c 00000000
pre:	 ME[18]: 00000001 00000007 00000007 00000000 0000000e 00000007 00000000 00000007
pre:	 ME[20]: 00000000 00000007 00000007 00000000 00000000 00000000 00000000 00000000
pre:	 ME[28]: 00000000 00000000 00000000 00000000 xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: c0002600 00000000 ........ ........
idle:	ROQ[00]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	ROQ[08]: 80000000 c0004600 00000007 c0002600 00000000 00000000 00000000 00000000
idle:	PFP[00]: ........ ........ ........ ........
idle:	PFP[04]: ........ ........ ........ ........
idle:	PFP[08]: ........ ........ ........ ........
idle:	PFP[0c]: ........ ........ ........ ........
idle:	PFP[10]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ c0002600 00000005 ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ 0000002a ........ ........ 084988ca 000001f6
idle:	 ME[10]: 00000000 ........ ........ ........ ........ ........ ........ ........
idle:	 ME[18]: ........ 00000000 00000000 ........ 00000000 00000000 ........ 00000000
idle:	 ME[20]: ........ 00000000 00000000 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_LOAD_STATE
RING[107e9074]: c0033000
RING[107e9078]: 00600000
RING[107e907c]: 00000001
RING[107e9080]: 34567890
RING[107e9084]: 09876543
pre:	MEQ[00]: 00000000 00000000 00000000 0000057d
pre:	MEQ[04]: 12345678 c0012d00 feffe57e 87654321
pre:	MEQ[08]: c0004000 80000000 c0004600 00000007
pre:	MEQ[0c]: c0002600 00000000 00000000 00000000
pre:	ROQ[00]: 80000000 00000000 00000000 00000000 80000000 c0004600 00000007 00000000
pre:	ROQ[08]: 80000000 c0004600 00000007 c0002600 00000000 00000000 00000000 00000000
pre:	PFP[00]: 00000000 00000000 00000000 00000000
pre:	PFP[04]: 00000000 00000000 00000000 00000000
pre:	PFP[08]: 00000000 00000000 00000000 00000000
pre:	PFP[0c]: 00000000 80000000 00000000 00000000
pre:	PFP[10]: 00000000 00000000 00000000 00000000
pre:	 ME[00]: 00003fff 00000000 c0002600 00000005 0000057e 00000000 00000000 00000000
pre:	 ME[08]: 00000000 00000000 80000000 0000002a 00000000 00000000 084988ca 000001f6
pre:	 ME[10]: 00000000 00000001 00000000 003ff036 c0200400 00000000 0000003c 00000000
pre:	 ME[18]: 00000001 00000000 00000000 00000000 00000000 00000000 00000000 00000000
pre:	 ME[20]: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
pre:	 ME[28]: 00000000 00000000 00000000 00000000 xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
idle:	MEQ[00]: 00000001 34567890 09876543 ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ c0033000 00600000
idle:	ROQ[00]: 00000000 c0033000 00600000 00000001 34567890 09876543 00000000 ........
idle:	ROQ[08]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	PFP[00]: ........ ........ ........ ........
idle:	PFP[04]: ........ ........ ........ ........
idle:	PFP[08]: ........ ........ ........ ........
idle:	PFP[0c]: ........ ........ ........ ........
idle:	PFP[10]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ c0033000 00000039 00000001 ........ ........ 0000a308
idle:	 ME[08]: ........ ........ ........ 0000007c ........ ........ 08498cca 0000a308
idle:	 ME[10]: 09876543 ........ ........ ........ ........ ........ 00000015 ........
idle:	 ME[18]: ........ 09876543 09876543 ........ 130eca86 09876543 ........ 09876543
idle:	 ME[20]: ........ 09876543 09876543 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_SET_BIN_MASK
   before: BIN_MASK:ffffffff_ffffffff BIN_SELECT:ffffffff_ffffffff
   MIU_TAG_STAT:00000000
   IB1_BASE:00000000
RING[107e9088]: c0015000
RING[107e908c]: 45678900
RING[107e9090]: 10987650
pre:	MEQ[00]: 00000001 34567890 09876543 0000057d
pre:	MEQ[04]: 12345678 c0012d00 feffe57e 87654321
pre:	MEQ[08]: c0004000 80000000 c0004600 00000007
pre:	MEQ[0c]: c0002600 00000000 c0033000 00600000
pre:	ROQ[00]: 00000000 c0033000 00600000 00000001 34567890 09876543 00000000 00000000
pre:	ROQ[08]: 80000000 c0004600 00000007 c0002600 00000000 00000000 00000000 00000000
pre:	PFP[00]: 00000000 00000000 00000000 00000000
pre:	PFP[04]: 00000000 00000000 00000000 00000000
pre:	PFP[08]: 00000000 00000000 00000000 00000000
pre:	PFP[0c]: 00000000 80000000 00000000 00000000
pre:	PFP[10]: 00000000 00000000 00000000 00000000
pre:	 ME[00]: 00003fff 00000000 c0033000 00000039 00000001 00000000 00000000 0000a308
pre:	 ME[08]: 00000000 00000000 80000000 0000007c 00000000 00000000 08498cca 0000a308
pre:	 ME[10]: 09876543 00000001 00000000 003ff036 c0200400 00000000 00000015 00000000
pre:	 ME[18]: 00000001 09876543 09876543 00000000 130eca86 09876543 00000000 09876543
pre:	 ME[20]: 00000000 09876543 09876543 00000000 00000000 00000000 00000000 00000000
pre:	 ME[28]: 00000000 00000000 00000000 00000000 xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	ROQ[00]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	ROQ[08]: 34567890 09876543 c0015000 45678900 10987650 ........ ........ ........
idle:	PFP[00]: ........ ........ ........ ........
idle:	PFP[04]: ........ ........ ........ ........
idle:	PFP[08]: ........ ........ ........ ........
idle:	PFP[0c]: ........ ........ ........ ........
idle:	PFP[10]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[10]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[18]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[20]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
   after: BIN_MASK:10987650_45678900 BIN_SELECT:ffffffff_ffffffff
   MIU_TAG_STAT:00000000
   IB1_BASE:00000000

PKT3: CP_SET_BIN_SELECT
   before: BIN_MASK:10987650_45678900 BIN_SELECT:ffffffff_ffffffff
   MIU_TAG_STAT:00000000
   IB1_BASE:00000000
RING[107e9094]: c0015100
RING[107e9098]: 55678900
RING[107e909c]: 20987650
pre:	MEQ[00]: 00000001 34567890 09876543 0000057d
pre:	MEQ[04]: 12345678 c0012d00 feffe57e 87654321
pre:	MEQ[08]: c0004000 80000000 c0004600 00000007
pre:	MEQ[0c]: c0002600 00000000 c0033000 00600000
pre:	ROQ[00]: 00000000 c0033000 00600000 00000001 34567890 09876543 00000000 00000000
pre:	ROQ[08]: 34567890 09876543 c0015000 45678900 10987650 00000000 00000000 00000000
pre:	PFP[00]: 00000000 00000000 00000000 00000000
pre:	PFP[04]: 00000000 00000000 00000000 00000000
pre:	PFP[08]: 00000000 00000000 00000000 00000000
pre:	PFP[0c]: 00000000 80000000 00000000 00000000
pre:	PFP[10]: 00000000 00000000 00000000 00000000
pre:	 ME[00]: 00003fff 00000000 c0033000 00000039 00000001 00000000 00000000 0000a308
pre:	 ME[08]: 00000000 00000000 80000000 0000007c 00000000 00000000 08498cca 0000a308
pre:	 ME[10]: 09876543 00000001 00000000 003ff036 c0200400 00000000 00000015 00000000
pre:	 ME[18]: 00000001 09876543 09876543 00000000 130eca86 09876543 00000000 09876543
pre:	 ME[20]: 00000000 09876543 09876543 00000000 00000000 00000000 00000000 00000000
pre:	 ME[28]: 00000000 00000000 00000000 00000000 xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	ROQ[00]: 10987650 c0015100 55678900 20987650 ........ ........ ........ ........
idle:	ROQ[08]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	PFP[00]: ........ ........ ........ ........
idle:	PFP[04]: ........ ........ ........ ........
idle:	PFP[08]: ........ ........ ........ ........
idle:	PFP[0c]: ........ ........ ........ ........
idle:	PFP[10]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[10]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[18]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[20]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
   after: BIN_MASK:10987650_45678900 BIN_SELECT:20987650_55678900
   MIU_TAG_STAT:00000000
   IB1_BASE:00000000

PKT3: CP_INVALIDATE_STATE
RING[107e90a0]: c0003b00
RING[107e90a4]: 00007fff
pre:	MEQ[00]: 00000001 34567890 09876543 0000057d
pre:	MEQ[04]: 12345678 c0012d00 feffe57e 87654321
pre:	MEQ[08]: c0004000 80000000 c0004600 00000007
pre:	MEQ[0c]: c0002600 00000000 c0033000 00600000
pre:	ROQ[00]: 10987650 c0015100 55678900 20987650 34567890 09876543 00000000 00000000
pre:	ROQ[08]: 34567890 09876543 c0015000 45678900 10987650 00000000 00000000 00000000
pre:	PFP[00]: 00000000 00000000 00000000 00000000
pre:	PFP[04]: 00000000 00000000 00000000 00000000
pre:	PFP[08]: 00000000 00000000 00000000 00000000
pre:	PFP[0c]: 00000000 80000000 00000000 00000000
pre:	PFP[10]: 00000000 00000000 00000000 00000000
pre:	 ME[00]: 00003fff 00000000 c0033000 00000039 00000001 00000000 00000000 0000a308
pre:	 ME[08]: 00000000 00000000 80000000 0000007c 00000000 00000000 08498cca 0000a308
pre:	 ME[10]: 09876543 00000001 00000000 003ff036 c0200400 00000000 00000015 00000000
pre:	 ME[18]: 00000001 09876543 09876543 00000000 130eca86 09876543 00000000 09876543
pre:	 ME[20]: 00000000 09876543 09876543 00000000 00000000 00000000 00000000 00000000
pre:	 ME[28]: 00000000 00000000 00000000 00000000 xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	ROQ[00]: ........ ........ ........ ........ c0003b00 00007fff ........ ........
idle:	ROQ[08]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	PFP[00]: ........ ........ ........ ........
idle:	PFP[04]: ........ ........ ........ ........
idle:	PFP[08]: ........ ........ ........ ........
idle:	PFP[0c]: ........ ........ ........ ........
idle:	PFP[10]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[10]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[18]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[20]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_NOP
RING[107e90a8]: c0001000
RING[107e90ac]: 23232323
pre:	MEQ[00]: 00000001 34567890 09876543 0000057d
pre:	MEQ[04]: 12345678 c0012d00 feffe57e 87654321
pre:	MEQ[08]: c0004000 80000000 c0004600 00000007
pre:	MEQ[0c]: c0002600 00000000 c0033000 00600000
pre:	ROQ[00]: 10987650 c0015100 55678900 20987650 c0003b00 00007fff 00000000 00000000
pre:	ROQ[08]: 34567890 09876543 c0015000 45678900 10987650 00000000 00000000 00000000
pre:	PFP[00]: 00000000 00000000 00000000 00000000
pre:	PFP[04]: 00000000 00000000 00000000 00000000
pre:	PFP[08]: 00000000 00000000 00000000 00000000
pre:	PFP[0c]: 00000000 80000000 00000000 00000000
pre:	PFP[10]: 00000000 00000000 00000000 00000000
pre:	 ME[00]: 00003fff 00000000 c0033000 00000039 00000001 00000000 00000000 0000a308
pre:	 ME[08]: 00000000 00000000 80000000 0000007c 00000000 00000000 08498cca 0000a308
pre:	 ME[10]: 09876543 00000001 00000000 003ff036 c0200400 00000000 00000015 00000000
pre:	 ME[18]: 00000001 09876543 09876543 00000000 130eca86 09876543 00000000 09876543
pre:	 ME[20]: 00000000 09876543 09876543 00000000 00000000 00000000 00000000 00000000
pre:	 ME[28]: 00000000 00000000 00000000 00000000 xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	ROQ[00]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	ROQ[08]: c0003b00 00007fff c0001000 23232323 ........ ........ ........ ........
idle:	PFP[00]: ........ ........ ........ ........
idle:	PFP[04]: ........ ........ ........ ........
idle:	PFP[08]: ........ ........ ........ ........
idle:	PFP[0c]: ........ ........ ........ ........
idle:	PFP[10]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[10]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[18]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[20]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_REG_RMW[REG_AXXX_CP_SCRATCH_REG6]
RING[107e90b0]: c0022100
RING[107e90b4]: 0000057e
RING[107e90b8]: 56565656
RING[107e90bc]: 98989898
pre:	MEQ[00]: 00000001 34567890 09876543 0000057d
pre:	MEQ[04]: 12345678 c0012d00 feffe57e 87654321
pre:	MEQ[08]: c0004000 80000000 c0004600 00000007
pre:	MEQ[0c]: c0002600 00000000 c0033000 00600000
pre:	ROQ[00]: 10987650 c0015100 55678900 20987650 c0003b00 00007fff 00000000 00000000
pre:	ROQ[08]: c0003b00 00007fff c0001000 23232323 10987650 00000000 00000000 00000000
pre:	PFP[00]: 00000000 00000000 00000000 00000000
pre:	PFP[04]: 00000000 00000000 00000000 00000000
pre:	PFP[08]: 00000000 00000000 00000000 00000000
pre:	PFP[0c]: 00000000 80000000 00000000 00000000
pre:	PFP[10]: 00000000 00000000 00000000 00000000
pre:	 ME[00]: 00003fff 00000000 c0033000 00000039 00000001 00000000 00000000 0000a308
pre:	 ME[08]: 00000000 00000000 80000000 0000007c 00000000 00000000 08498cca 0000a308
pre:	 ME[10]: 09876543 00000001 00000000 003ff036 c0200400 00000000 00000015 00000000
pre:	 ME[18]: 00000001 09876543 09876543 00000000 130eca86 09876543 00000000 09876543
pre:	 ME[20]: 00000000 09876543 09876543 00000000 00000000 00000000 00000000 00000000
pre:	 ME[28]: 00000000 00000000 00000000 00000000 xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
idle:	MEQ[00]: ........ ........ ........ c0022100
idle:	MEQ[04]: 0000057e 56565656 98989898 ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	ROQ[00]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	ROQ[08]: ........ ........ ........ ........ c0022100 0000057e 56565656 98989898
idle:	PFP[00]: ........ ........ ........ ........
idle:	PFP[04]: ........ ........ ........ ........
idle:	PFP[08]: ........ ........ ........ ........
idle:	PFP[0c]: ........ ........ ........ ........
idle:	PFP[10]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ c0022100 0000057e 00000000 ........ ........ 56565656
idle:	 ME[08]: 98989898 ........ 00000000 00000061 ........ ........ 084988ca 0000057f
idle:	 ME[10]: 98989898 ........ ........ ........ ........ ........ 00000002 ........
idle:	 ME[18]: 00000003 98989898 98989898 ........ 31313130 98989898 ........ 98989898
idle:	 ME[20]: ........ 98989898 98989898 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_SET_BIN
RING[107e90c0]: c0024c00
RING[107e90c4]: 00000000
RING[107e90c8]: 018002e0
RING[107e90cc]: 04000440
pre:	MEQ[00]: 00000001 34567890 09876543 c0022100
pre:	MEQ[04]: 0000057e 56565656 98989898 87654321
pre:	MEQ[08]: c0004000 80000000 c0004600 00000007
pre:	MEQ[0c]: c0002600 00000000 c0033000 00600000
pre:	ROQ[00]: 10987650 c0015100 55678900 20987650 c0003b00 00007fff 00000000 00000000
pre:	ROQ[08]: c0003b00 00007fff c0001000 23232323 c0022100 0000057e 56565656 98989898
pre:	PFP[00]: 00000000 00000000 00000000 00000000
pre:	PFP[04]: 00000000 00000000 00000000 00000000
pre:	PFP[08]: 00000000 00000000 00000000 00000000
pre:	PFP[0c]: 00000000 80000000 00000000 00000000
pre:	PFP[10]: 00000000 00000000 00000000 00000000
pre:	 ME[00]: 00003fff 00000000 c0022100 0000057e 00000000 00000000 00000000 56565656
pre:	 ME[08]: 98989898 00000000 00000000 00000061 00000000 00000000 084988ca 0000057f
pre:	 ME[10]: 98989898 00000001 00000000 003ff036 c0200400 00000000 00000002 00000000
pre:	 ME[18]: 00000003 98989898 98989898 00000000 31313130 98989898 00000000 98989898
pre:	 ME[20]: 00000000 98989898 98989898 00000000 00000000 00000000 00000000 00000000
pre:	 ME[28]: 00000000 00000000 00000000 00000000 xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ c0024c00
idle:	MEQ[08]: 00000000 018002e0 04000440 ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	ROQ[00]: c0024c00 00000000 018002e0 04000440 ........ ........ ........ ........
idle:	ROQ[08]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	PFP[00]: ........ ........ ........ ........
idle:	PFP[04]: ........ ........ ........ ........
idle:	PFP[08]: ........ ........ ........ ........
idle:	PFP[0c]: ........ ........ ........ ........
idle:	PFP[10]: ........ ........ ........ ........
idle:	 ME[00]: 00000000 ........ 00000002 00000019 ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ 0000025e ........ ........ 024918ca ........
idle:	 ME[10]: ........ ........ ........ ........ ........ ........ 0000003d ........
idle:	 ME[18]: 00000001 04000440 04000440 ........ 08000880 04000440 ........ 04000440
idle:	 ME[20]: ........ 04000440 04000440 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_SET_BIN_DATA
RING[107e90d0]: c0012f00
RING[107e90d4]: 11223300
RING[107e90d8]: 44444400
pre:	MEQ[00]: 00000001 34567890 09876543 c0022100
pre:	MEQ[04]: 0000057e 56565656 98989898 c0024c00
pre:	MEQ[08]: 00000000 018002e0 04000440 00000007
pre:	MEQ[0c]: c0002600 00000000 c0033000 00600000
pre:	ROQ[00]: c0024c00 00000000 018002e0 04000440 c0003b00 00007fff 00000000 00000000
pre:	ROQ[08]: c0003b00 00007fff c0001000 23232323 c0022100 0000057e 56565656 98989898
pre:	PFP[00]: 00000000 00000000 00000000 00000000
pre:	PFP[04]: 00000000 00000000 00000000 00000000
pre:	PFP[08]: 00000000 00000000 00000000 00000000
pre:	PFP[0c]: 00000000 80000000 00000000 00000000
pre:	PFP[10]: 00000000 00000000 00000000 00000000
pre:	 ME[00]: 00000000 00000000 00000002 00000019 00000000 00000000 00000000 56565656
pre:	 ME[08]: 98989898 00000000 00000000 0000025e 00000000 00000000 024918ca 0000057f
pre:	 ME[10]: 98989898 00000001 00000000 003ff036 c0200400 00000000 0000003d 00000000
pre:	 ME[18]: 00000001 04000440 04000440 00000000 08000880 04000440 00000000 04000440
pre:	 ME[20]: 00000000 04000440 04000440 00000000 00000000 00000000 00000000 00000000
pre:	 ME[28]: 00000000 00000000 00000000 00000000 xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
idle:	MEQ[00]: ........ ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ c0012f00
idle:	MEQ[0c]: 11223300 44444400 ........ ........
idle:	ROQ[00]: ........ ........ ........ ........ c0012f00 11223300 44444400 ........
idle:	ROQ[08]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	PFP[00]: ........ ........ ........ ........
idle:	PFP[04]: ........ ........ ........ ........
idle:	PFP[08]: ........ ........ ........ ........
idle:	PFP[0c]: ........ ........ ........ ........
idle:	PFP[10]: ........ ........ ........ ........
idle:	 ME[00]: 00003fff ........ 11223300 00000007 ........ 44444400 ........ ........
idle:	 ME[08]: ........ ........ ........ 00000256 ........ ........ 02498aca 000001f6
idle:	 ME[10]: 00000000 ........ ........ ........ ........ ........ 0000000d ........
idle:	 ME[18]: ........ 44444400 44444400 ........ 88888800 44444400 ........ 44444400
idle:	 ME[20]: ........ 44444400 44444400 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_MEM_WRITE
RING[107e90dc]: c0013d00
RING[107e90e0]: 107f1004
RING[107e90e4]: 11221122
pre:	MEQ[00]: 00000001 34567890 09876543 c0022100
pre:	MEQ[04]: 0000057e 56565656 98989898 c0024c00
pre:	MEQ[08]: 00000000 018002e0 04000440 c0012f00
pre:	MEQ[0c]: 11223300 44444400 c0033000 00600000
pre:	ROQ[00]: c0024c00 00000000 018002e0 04000440 c0012f00 11223300 44444400 00000000
pre:	ROQ[08]: c0003b00 00007fff c0001000 23232323 c0022100 0000057e 56565656 98989898
pre:	PFP[00]: 00000000 00000000 00000000 00000000
pre:	PFP[04]: 00000000 00000000 00000000 00000000
pre:	PFP[08]: 00000000 00000000 00000000 00000000
pre:	PFP[0c]: 00000000 80000000 00000000 00000000
pre:	PFP[10]: 00000000 00000000 00000000 00000000
pre:	 ME[00]: 00003fff 00000000 11223300 00000007 00000000 44444400 00000000 56565656
pre:	 ME[08]: 98989898 00000000 00000000 00000256 00000000 00000000 02498aca 000001f6
pre:	 ME[10]: 00000000 00000001 00000000 003ff036 c0200400 00000000 0000000d 00000000
pre:	 ME[18]: 00000001 44444400 44444400 00000000 88888800 44444400 00000000 44444400
pre:	 ME[20]: 00000000 44444400 44444400 00000000 00000000 00000000 00000000 00000000
pre:	 ME[28]: 00000000 00000000 00000000 00000000 xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
idle:	MEQ[00]: 11221122 ........ ........ ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ c0013d00 107f1004
idle:	ROQ[00]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	ROQ[08]: c0012f00 11223300 44444400 c0013d00 107f1004 11221122 00000000 00000000
idle:	PFP[00]: ........ ........ ........ ........
idle:	PFP[04]: ........ ........ ........ ........
idle:	PFP[08]: ........ ........ ........ ........
idle:	PFP[0c]: ........ ........ ........ ........
idle:	PFP[10]: ........ ........ ........ ........
idle:	 ME[00]: ........ ........ c0013d00 0000000b ........ ........ ........ ........
idle:	 ME[08]: ........ ........ ........ 0000013d ........ ........ 084988ca 0000860e
idle:	 ME[10]: 11221122 ........ ........ ........ ........ ........ 00000000 ........
idle:	 ME[18]: ........ 11221122 11221122 ........ 22442244 11221122 ........ 11221122
idle:	 ME[20]: ........ 11221122 11221122 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx

PKT3: CP_DRAW_INDX
RING[107e90e8]: c0022200
RING[107e90ec]: 00000000
RING[107e90f0]: 00004088
RING[107e90f4]: 00000000
pre:	MEQ[00]: 11221122 34567890 09876543 c0022100
pre:	MEQ[04]: 0000057e 56565656 98989898 c0024c00
pre:	MEQ[08]: 00000000 018002e0 04000440 c0012f00
pre:	MEQ[0c]: 11223300 44444400 c0013d00 107f1004
pre:	ROQ[00]: c0024c00 00000000 018002e0 04000440 c0012f00 11223300 44444400 00000000
pre:	ROQ[08]: c0012f00 11223300 44444400 c0013d00 107f1004 11221122 00000000 00000000
pre:	PFP[00]: 00000000 00000000 00000000 00000000
pre:	PFP[04]: 00000000 00000000 00000000 00000000
pre:	PFP[08]: 00000000 00000000 00000000 00000000
pre:	PFP[0c]: 00000000 80000000 00000000 00000000
pre:	PFP[10]: 00000000 00000000 00000000 00000000
pre:	 ME[00]: 00003fff 00000000 c0013d00 0000000b 00000000 44444400 00000000 56565656
pre:	 ME[08]: 98989898 00000000 00000000 0000013d 00000000 00000000 084988ca 0000860e
pre:	 ME[10]: 11221122 00000001 00000000 003ff036 c0200400 00000000 00000000 00000000
pre:	 ME[18]: 00000001 11221122 11221122 00000000 22442244 11221122 00000000 11221122
pre:	 ME[20]: 00000000 11221122 11221122 00000000 00000000 00000000 00000000 00000000
pre:	 ME[28]: 00000000 00000000 00000000 00000000 xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx
idle:	MEQ[00]: ........ c0022200 00004088 ........
idle:	MEQ[04]: ........ ........ ........ ........
idle:	MEQ[08]: ........ ........ ........ ........
idle:	MEQ[0c]: ........ ........ ........ ........
idle:	ROQ[00]: 107f1004 11221122 c0022200 00000000 00004088 00000000 00000000 ........
idle:	ROQ[08]: ........ ........ ........ ........ ........ ........ ........ ........
idle:	PFP[00]: ........ ........ ........ ........
idle:	PFP[04]: ........ ........ ........ ........
idle:	PFP[08]: ........ ........ ........ ........
idle:	PFP[0c]: ........ ........ ........ ........
idle:	PFP[10]: ........ ........ ........ ........
idle:	 ME[00]: 00000001 ........ c0022200 00000004 00004088 ........ ........ ........
idle:	 ME[08]: ........ ........ ........ 00000014 ........ ........ ........ 000021fd
idle:	 ME[10]: 00004088 ........ ........ ........ ........ ........ 0000000c ........
idle:	 ME[18]: ........ 00004088 00004088 ........ 00008110 00004088 ........ 00004088
idle:	 ME[20]: ........ 00004088 00004088 ........ ........ ........ ........ ........
idle:	 ME[28]: ........ ........ ........ ........ xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx


 */

/* see a3xx_snapshot_cp_meq */
static void dump_meq_roq(struct msm_gpu *gpu, const char *str, bool first)
{
	static uint32_t meq[16], last_meq[16];
//	static uint32_t roq[128], last_roq[128];
	static uint32_t roq[16], last_roq[16];   // only first 16 seem touched (rest is IB1, IB2, ST..)
	static uint32_t pfp[0x14], last_pfp[0x14];
//	static uint32_t me[44],  last_me[44];
	static uint32_t me[0x80],  last_me[0x80];
	int i;
	void printval(uint32_t *buf, uint32_t *lastbuf, int i)
	{
		if (lastbuf && (lastbuf[i] == buf[i]))
			printk(" ........");
		else
			printk(" %08x", buf[i]);
	}

	gpu_write(gpu, REG_A3XX_CP_MEQ_ADDR, 0x0);
	for (i = 0; i < ARRAY_SIZE(meq); i++)
		meq[i] = gpu_read(gpu, REG_A3XX_CP_MEQ_DATA);

	gpu_write(gpu, REG_A3XX_CP_ROQ_ADDR, 0x0);
	for (i = 0; i < ARRAY_SIZE(roq); i++)
		roq[i] = gpu_read(gpu, REG_A3XX_CP_ROQ_DATA);

	for (i = 0; i < ARRAY_SIZE(pfp); i++) {
		gpu_write(gpu, REG_AXXX_CP_STATE_DEBUG_INDEX, i);
		pfp[i] = gpu_read(gpu, REG_AXXX_CP_STATE_DEBUG_DATA);
	}

	for (i = 0; i < ARRAY_SIZE(me); i++) {
		gpu_write(gpu, REG_AXXX_CP_ME_CNTL, i);
		me[i] = gpu_read(gpu, REG_AXXX_CP_ME_STATUS);
	}

	for (i = 0; i < ARRAY_SIZE(meq); i += 4) {
		uint32_t *lastbuf = first ? NULL : last_meq;
		printk("%s:\tMEQ[%02x]:", str, i);
		printval(meq, lastbuf, i+0);
		printval(meq, lastbuf, i+1);
		printval(meq, lastbuf, i+2);
		printval(meq, lastbuf, i+3);
		printk("\n");
	}

/*
	for (i = 0; i < ARRAY_SIZE(roq); i += 8) {
		uint32_t *lastbuf = first ? NULL : last_roq;
		printk("%s:\tROQ[%02x]:", str, i);
		printval(roq, lastbuf, i+0);
		printval(roq, lastbuf, i+1);
		printval(roq, lastbuf, i+2);
		printval(roq, lastbuf, i+3);
		printval(roq, lastbuf, i+4);
		printval(roq, lastbuf, i+5);
		printval(roq, lastbuf, i+6);
		printval(roq, lastbuf, i+7);
		printk("\n");
	}
*/

/*
	for (i = 0; i < ARRAY_SIZE(pfp); i += 4) {
		uint32_t *lastbuf = first ? NULL : last_pfp;
		printk("%s:\tPFP[%02x]:", str, i);
		printval(pfp, lastbuf, i+0);
		printval(pfp, lastbuf, i+1);
		printval(pfp, lastbuf, i+2);
		printval(pfp, lastbuf, i+3);
		printk("\n");
	}
*/

	for (i = 0; i < ARRAY_SIZE(me); i += 8) {
		uint32_t *lastbuf = first ? NULL : last_me;
		printk("%s:\t ME[%02x]:", str, i);
		printval(me, lastbuf, i+0);
		printval(me, lastbuf, i+1);
		printval(me, lastbuf, i+2);
		printval(me, lastbuf, i+3);
		printval(me, lastbuf, i+4);
		printval(me, lastbuf, i+5);
		printval(me, lastbuf, i+6);
		printval(me, lastbuf, i+7);
		printk("\n");
	}

	memcpy(last_meq, meq, sizeof(last_meq));
	memcpy(last_roq, roq, sizeof(last_roq));
	memcpy(last_pfp, pfp, sizeof(last_pfp));
	memcpy(last_me,  me,  sizeof(last_me));
}

static void a3xx_me_init(struct msm_gpu *gpu)
{
	struct msm_ringbuffer *ring = gpu->rb;

	printk("\nPKT3: CP_ME_INIT\n");
	OUT_PKT3(ring, CP_ME_INIT, 17);
	OUT_RING(ring, 0x000003f7);
	OUT_RING(ring, 0x00000000);
	OUT_RING(ring, 0x00000000);
	OUT_RING(ring, 0x00000000);
	OUT_RING(ring, 0x00000080);
	OUT_RING(ring, 0x00000100);
	OUT_RING(ring, 0x00000180);
	OUT_RING(ring, 0x00006600);
	OUT_RING(ring, 0x00000150);
	OUT_RING(ring, 0x0000014e);
	OUT_RING(ring, 0x00000154);
	OUT_RING(ring, 0x00000001);
	OUT_RING(ring, 0x00000000);
	OUT_RING(ring, 0x00000000);
	OUT_RING(ring, 0x00000000);
	OUT_RING(ring, 0x00000000);
	OUT_RING(ring, 0x00000000);

	dump_meq_roq(gpu, "pre", true);
	gpu->funcs->flush(gpu);
//	dump_meq_roq(gpu, "flush");
	gpu->funcs->idle(gpu);
	dump_meq_roq(gpu, "idle", false);
}

#define CP_REG(reg) ((0x4 << 16) | ((unsigned int)((reg) - (0x2000))))

static inline uint32_t DRAW(enum pc_di_primtype prim_type,
		enum pc_di_src_sel source_select, enum pc_di_index_size index_size,
		enum pc_di_vis_cull_mode vis_cull_mode)
{
	return (prim_type         << 0) |
			(source_select     << 6) |
			((index_size & 1)  << 11) |
			((index_size >> 1) << 13) |
			(vis_cull_mode     << 9) |
			(1                 << 14);
}

static void test_go(struct msm_gpu *gpu)
{
	dump_meq_roq(gpu, "pre", true);
	gpu->funcs->flush(gpu);
//mdelay(10);
//dump_meq_roq(gpu, "flush", false);
	gpu->funcs->idle(gpu);
	dump_meq_roq(gpu, "idle", false);
}

void run_meq_tests(struct msm_gpu *gpu)
{
	struct adreno_gpu *adreno_gpu = to_adreno_gpu(gpu);
	struct msm_ringbuffer *ring = gpu->rb;

	gpu->funcs->idle(gpu);

#if 0
	// XXX XXX XXX
	printk("\nPKT3: CP_WAIT_REG_EQ\n");
	OUT_PKT3(ring, CP_WAIT_REG_EQ, 4);
	OUT_RING(ring, REG_AXXX_CP_SCRATCH_REG5);
	OUT_RING(ring, 0x00000010);
	OUT_RING(ring, 0x00000011);
	OUT_RING(ring, 0x12345678);
#else
/*
(gdb) print/x instrs[0x2e]
$2 = {{d0 = 0x1f, d1 = 0x40280e20, d2 = 0x0}, {immed = 0x1f, pad0 = 0x220, dst = 0x3,
    pad1 = 0x20, op = 0x1, pad2 = 0x0, cond = 0x0, pad3 = 0x0, meq = 0x1, pad4 = 0x0,
    off = 0x0}}
ME[40]: 00000000 ........ 000000fe 0000001c<0000001e>........ ........ ........

(gdb) print/x instrs[0x2e]
$4 = {{d0 = 0x1f, d1 = 0x40200e20, d2 = 0x0}, {immed = 0x1f, pad0 = 0x220, dst = 0x3,
    pad1 = 0x0, op = 0x1, pad2 = 0x0, cond = 0x0, pad3 = 0x0, meq = 0x1, pad4 = 0x0,
    off = 0x0}}
ME[40]: 00000000 ........ 000000fe 0000001c<000000fe>........ ........ ........

(gdb) print/x instrs[0x2e]
$3 = {{d0 = 0x1f, d1 = 0x40280c20, d2 = 0x0}, {immed = 0x1f, pad0 = 0x20, dst = 0x3,
    pad1 = 0x20, op = 0x1, pad2 = 0x0, cond = 0x0, pad3 = 0x0, meq = 0x1, pad4 = 0x0,
    off = 0x0}}
ME[40]: 00000000 ........ 000000fe 0000001c<00000000>........ ........ ........

(gdb) print/x instrs[0x2e]
$4 = {{d0 = 0x1f, d1 = 0x40280e00, d2 = 0x0}, {immed = 0x1f, pad0 = 0x200, dst = 0x3,
    pad1 = 0x20, op = 0x1, pad2 = 0x0, cond = 0x0, pad3 = 0x0, meq = 0x1, pad4 = 0x0,
    off = 0x0}}
ME[40]: 00000000 ........ 000000fe 0000001c<00000000>........ ........ ........

(gdb) print/x instrs[0x2e]
$7 = {{d0 = 0x1f, d1 = 0x40240e00, d2 = 0x0}, {immed = 0x1f, pad0 = 0x200, dst = 0x3,
    pad1 = 0x10, op = 0x1, pad2 = 0x0, cond = 0x0, pad3 = 0x0, meq = 0x1, pad4 = 0x0,
    off = 0x0}}
ME[40]: 00000000 ........ 000000fe 0000001c<000000fe>........ ........ ........

(gdb) print/x instrs[0x2e]
$5 = {{d0 = 0x1f, d1 = 0x402c0e20, d2 = 0x0}, {immed = 0x1f, pad0 = 0x220, dst = 0x3,
    pad1 = 0x30, op = 0x1, pad2 = 0x0, cond = 0x0, pad3 = 0x0, meq = 0x1, pad4 = 0x0,
    off = 0x0}}
ME[40]: 00000000 ........ 000000fe 0000001c<00000000>........ ........ ........

(gdb) print/x instrs[0x2e]
$6 = {{d0 = 0x1f, d1 = 0x40300e00, d2 = 0x0}, {immed = 0x1f, pad0 = 0x200, dst = 0x3,
    pad1 = 0x40, op = 0x1, pad2 = 0x0, cond = 0x0, pad3 = 0x0, meq = 0x1, pad4 = 0x0,
    off = 0x0}}
ME[40]: 00000000 ........ 000000fe 0000001c<000000fe>........ ........ ........

(gdb) print/x instrs[0x2e]
$8 = {{d0 = 0x1f, d1 = 0x40380e00, d2 = 0x0}, {immed = 0x1f, pad0 = 0x200, dst = 0x3,
    pad1 = 0x60, op = 0x1, pad2 = 0x0, cond = 0x0, pad3 = 0x0, meq = 0x1, pad4 = 0x0,
    off = 0x0}}
ME[40]: 00000000 ........ 000000fe 0000001c<00000000>........ ........ ........

(gdb) print/x instrs[0x2e]
$10 = {{d0 = 0xfe, d1 = 0x402f0e00, d2 = 0x0}, {immed = 0xfe, pad0 = 0x200, dst = 0x3,
    pad1 = 0x3c, op = 0x1, pad2 = 0x0, cond = 0x0, pad3 = 0x0, meq = 0x1, pad4 = 0x0,
    off = 0x0}}
ME[40]: 00000000 ........ 000000fe 0000001c<00000000>........ ........ ........

(gdb) print/x instrs[0x2e]
$11 = {{d0 = 0xff, d1 = 0x402f0e00, d2 = 0x0}, {immed = 0xff, pad0 = 0x200, dst = 0x3,
    pad1 = 0x3c, op = 0x1, pad2 = 0x0, cond = 0x0, pad3 = 0x0, meq = 0x1, pad4 = 0x0,
    off = 0x0}}
ME[40]: 00000000 ........ 000000fe 0000001c<00000000>........ ........ ........

 */
	printk("\nPKT3:CP_EVENT_WRITE\n");
	OUT_PKT3(ring, CP_EVENT_WRITE, 1);
	OUT_RING(ring, 0xfe);
#endif
	/* don't gpu->idle() as we are killing the CP.. */
	dump_meq_roq(gpu, "pre", true);
	gpu->funcs->flush(gpu);
	mdelay(100);
	dump_meq_roq(gpu, "idle", false);

	if (1) return;
	// XXX XXX XXX
/*
INVALID_JUMPTABLE_ENTRY:
0002:      000001f3 00204411 00000000   0-00---00-+0000001---+0000010001   mov $addr, ???     ;(imm:CP_INT_STATUS)
0003:      01000000 00204811 00000000   0-00---00-+0000001--+-0000010001   mov $data, ???     ;(imm:CP_INT_STATUS.OPCODE_ERROR_STAT)
0004: l00: 00000000 00400000 00000004   0-00---00+-0000000----0000000000   jmp $0, ???        ;(branch:#l00)

CP_MEM_WRITE:
013d: l48: 0000060d 00204411 00000000   0-00---00-+0000001---+0000010001   mov $addr, ???     ;(imm:CP_ME_NRT_ADDR)
013e:      00000000 c0204800 00000000   1+00---00-+0000001--+-0000000000   mov $data, $meq    ;(imm:<00000000>)
013f:      0000860e 00204411 00000000   0-00---00-+0000001---+0000010001   mov $addr, ???     ;(imm:(CP_ME_NRT_DATA | 0x8000))
0140:      00000000 d9004800 00000000   1+01+--10--0000001--+-0000000000   op0.c4 $data, $meq ;
0141:      00000000 00400000 00000000   0-00---00+-0000000----0000000000   jmp $0, ???        ;(branch:#l01)

CP_INTERRUPT:
0193:      00000060 00204411 00000000   0-00---00-+0000001---+0000010001   mov $addr, ???     ;(imm:RBBM_INT_SET_CMD)
0194:      e0000000 c0280a20 00000000   1+00---00-+0100000--+-1000100000   mov $data, $meq    ;(imm:<e0000000>)
0195:      00000010 00414a22 00000000   0-00---00+-0000101--+-1000100010   jmp $data, ???     ;(branch:#l01)
0196: l25: 00003fff 002f022f 00000000   0-00---00-+0111100----1000101111   mov $0, ???        ;(imm:<00003fff>)
0197:      00000000 0ce00000 00000000   0-00++-01++0000000----0000000000   br.eq $0, ???      ;(imm:<00000000>)(branch:#l01)

CP_INTERRUPT:
0156:      000001f3 00204411 00000000   0-00---00-+0000001---+0000010001   mov $addr, ???     ;(imm:CP_INT_STATUS)
0157:      e0000000 c0484a20 00000000   1+00---00+-0100001--+-1000100000   jmp $data, $meq    ;(branch:#l01)

CP_WAIT_REG_EQ:
0125:      00000000 c0201000 00000000   1+00---00-+0000000-+--0000000000   mov $4, $meq       ;(imm:<00000000>)
0126:      00000000 c0201400 00000000   1+00---00-+0000000-+-+0000000000   mov $5, $meq       ;(imm:<00000000>)
0127:      00000000 c0201800 00000000   1+00---00-+0000000-++-0000000000   mov $6, $meq       ;(imm:<00000000>)
0128:      00000000 c0201c00 00000000   1+00---00-+0000000-+++0000000000   mov $7, $meq       ;(imm:<00000000>)
0129: l50: 00000000 17000000 00000000   0-01-++10--0000000----0000000000   op0.gte $0, ???    ;
012a:      8100ffff 00204411 00000000   0-00---00-+0000001---+0000010001   mov $addr, ???     ;(imm:<8100ffff>)
012b:      00000001 00204811 00000000   0-00---00-+0000001--+-0000010001   mov $data, ???     ;(imm:<00000001>)
012c:      00040000 00694624 00000280   0-00---00++0100101---+1000100100   br $addr, ???      ;(imm:<00040000>)(branch:#l16)
012d:      00000000 002820d0 00000000   0-00---00-+0100000+---0011010000   mov $8, ???        ;(imm:<00000000>)
012e:      00000000 002f00a8 00000000   0-00---00-+0111100----0010101000   mov $0, ???        ;(imm:<00000000>)
012f:      00000000 0ce00000 00000000   0-00++-01++0000000----0000000000   br.eq $0, ???      ;(imm:<00000000>)(branch:#l01)
0130:      00000000 00404c07 00000129   0-00---00+-0000001--++0000000111   jmp $3, ???        ;(branch:#l50)

CP_DRAW_INDX:
CP_DRAW_INDX_BIN:
0014: l05: 00000000 1cc00000 00000014   0-01++-01+-0000000----0000000000   jmp.eq $0, ???     ;(branch:#l05)
0015:      00000000 26e00000 00000017   0-10-++01++0000000----0000000000   br.gte $0, ???     ;(imm:<00000000>)(branch:#l06)
0016:      00000000 00600000 00000247   0-00---00++0000000----0000000000   br $0, ???         ;(imm:<00000000>)(branch:#l07)
0017: l06: 00000001 00205011 00000000   0-00---00-+0000001-+--0000010001   mov $4, ???        ;(imm:<00000001>)
0018:      00000000 c0200c00 00000000   1+00---00-+0000000--++0000000000   mov $3, $meq       ;(imm:<00000000>)
0019:      000021fc 0029462c 00000000   0-00---00-+0100101---+1000101100   mov $addr, ???     ;(imm:VGT_DRAW_INITIATOR)
001a:      00000000 00404803 00000000   0-00---00+-0000001--+-0000000011   jmp $data, ???     ;(branch:#l01)

 */


#if 1
	printk("\nPKT0: CP_SCRATCH_REG5\n");
	OUT_PKT0(ring, REG_AXXX_CP_SCRATCH_REG5, 1);
	OUT_RING(ring, 0x12345678);
	test_go(gpu);

	printk("\nPKT3: CP_WAIT_REG_EQ\n");
	OUT_PKT3(ring, CP_WAIT_REG_EQ, 4);
	OUT_RING(ring, REG_AXXX_CP_SCRATCH_REG5);
	OUT_RING(ring, 0x00000010);
	OUT_RING(ring, 0x00000011);
	OUT_RING(ring, 0x12345678);
	test_go(gpu);

	printk("\nPKT3: CP_SET_CONSTANT[CP_SCRATCH_REG6]\n");
	OUT_PKT3(ring, CP_SET_CONSTANT, 2);
	OUT_RING(ring, CP_REG(REG_AXXX_CP_SCRATCH_REG6));
	OUT_RING(ring, 0x87654321);
	test_go(gpu);

	printk("\nPKT3: CP_INTERRUPT\n");
	OUT_PKT3(ring, CP_INTERRUPT, 1);
	OUT_RING(ring, 0x80000000);
	test_go(gpu);

	printk("\nPKT3: CP_EVENT_WRITE\n");
	OUT_PKT3(ring, CP_EVENT_WRITE, 1);
	OUT_RING(ring, HLSQ_FLUSH);
	test_go(gpu);

	printk("\nPKT3: CP_WAIT_FOR_IDLE\n");
	OUT_PKT3(ring, CP_WAIT_FOR_IDLE, 1);
	OUT_RING(ring, 0x00000000);
	test_go(gpu);

	printk("\nPKT3: CP_LOAD_STATE\n");
	OUT_PKT3(ring, CP_LOAD_STATE, 4);
	OUT_RING(ring, CP_LOAD_STATE_0_DST_OFF(0) |
			CP_LOAD_STATE_0_STATE_SRC(SS_DIRECT) |
			CP_LOAD_STATE_0_STATE_BLOCK(SB_VERT_SHADER) |
			CP_LOAD_STATE_0_NUM_UNIT(1));
	OUT_RING(ring, CP_LOAD_STATE_1_EXT_SRC_ADDR(0) |
			CP_LOAD_STATE_1_STATE_TYPE(ST_CONSTANTS));
	OUT_RING(ring, 0x34567890);
	OUT_RING(ring, 0x09876543);
	test_go(gpu);
#endif
/*
	<reg32 offset="0x0454" name="CP_BIN_MASK_LO"/>
	<reg32 offset="0x0455" name="CP_BIN_MASK_HI"/>
	<reg32 offset="0x0456" name="CP_BIN_SELECT_LO"/>
	<reg32 offset="0x0457" name="CP_BIN_SELECT_HI"/>
 */

	printk("\nPKT3: CP_SET_BIN_MASK\n");
	printk("   before: BIN_MASK:%08x_%08x BIN_SELECT:%08x_%08x\n",
			gpu_read(gpu, 0x0454), gpu_read(gpu, 0x0455),
			gpu_read(gpu, 0x0456), gpu_read(gpu, 0x0457));
	printk("   MIU_TAG_STAT:%08x\n", gpu_read(gpu, 0x0452));
	printk("   IB1_BASE:%08x\n",gpu_read(gpu, 0x0458));
	OUT_PKT3(ring, CP_SET_BIN_MASK, 2);
	OUT_RING(ring, 0x45678900);
	OUT_RING(ring, 0x10987650);
	test_go(gpu);
	printk("   after: BIN_MASK:%08x_%08x BIN_SELECT:%08x_%08x\n",
			gpu_read(gpu, 0x0454), gpu_read(gpu, 0x0455),
			gpu_read(gpu, 0x0456), gpu_read(gpu, 0x0457));
	printk("   MIU_TAG_STAT:%08x\n", gpu_read(gpu, 0x0452));
	printk("   IB1_BASE:%08x\n",gpu_read(gpu, 0x0458));

	printk("\nPKT3: CP_SET_BIN_SELECT\n");
	printk("   before: BIN_MASK:%08x_%08x BIN_SELECT:%08x_%08x\n",
			gpu_read(gpu, 0x0454), gpu_read(gpu, 0x0455),
			gpu_read(gpu, 0x0456), gpu_read(gpu, 0x0457));
	printk("   MIU_TAG_STAT:%08x\n", gpu_read(gpu, 0x0452));
	printk("   IB1_BASE:%08x\n",gpu_read(gpu, 0x0458));
	OUT_PKT3(ring, CP_SET_BIN_SELECT, 2);
	OUT_RING(ring, 0x55678900);
	OUT_RING(ring, 0x20987650);
	test_go(gpu);
	printk("   after: BIN_MASK:%08x_%08x BIN_SELECT:%08x_%08x\n",
			gpu_read(gpu, 0x0454), gpu_read(gpu, 0x0455),
			gpu_read(gpu, 0x0456), gpu_read(gpu, 0x0457));
	printk("   MIU_TAG_STAT:%08x\n", gpu_read(gpu, 0x0452));
	printk("   IB1_BASE:%08x\n",gpu_read(gpu, 0x0458));

#if 1
	printk("\nPKT3: CP_INVALIDATE_STATE\n");
	OUT_PKT3(ring, CP_INVALIDATE_STATE, 1);
	OUT_RING(ring, 0x00007fff);
	test_go(gpu);

	printk("\nPKT3: CP_NOP\n");
	OUT_PKT3(ring, CP_NOP, 1);
	OUT_RING(ring, 0x23232323);
	test_go(gpu);

	printk("\nPKT3: CP_REG_RMW[REG_AXXX_CP_SCRATCH_REG6]\n");
	OUT_PKT3(ring, CP_REG_RMW, 3);
	OUT_RING(ring, REG_AXXX_CP_SCRATCH_REG6);
	OUT_RING(ring, 0x56565656);
	OUT_RING(ring, 0x98989898);
	test_go(gpu);

	printk("\nPKT3: CP_SET_BIN\n");
	OUT_PKT3(ring, CP_SET_BIN, 3);
	OUT_RING(ring, 0x00000000);
	OUT_RING(ring, CP_SET_BIN_1_X1(23*32) | CP_SET_BIN_1_Y1(12*32));
	OUT_RING(ring, CP_SET_BIN_2_X2(34*32) | CP_SET_BIN_2_Y2(32*32));
	test_go(gpu);

	printk("\nPKT3: CP_SET_BIN_DATA\n");
	OUT_PKT3(ring, CP_SET_BIN_DATA, 2);
	OUT_RING(ring, 0x11223300);
	OUT_RING(ring, 0x44444400);
	test_go(gpu);

#define rbmemptr(adreno_gpu, member)  \
	((adreno_gpu)->memptrs_iova + offsetof(struct adreno_rbmemptrs, member))

	printk("\nPKT3: CP_MEM_WRITE\n");
	OUT_PKT3(ring, CP_MEM_WRITE, 2);
	OUT_RING(ring, rbmemptr(adreno_gpu, wptr));
	OUT_RING(ring, 0x11221122);
	test_go(gpu);

	printk("\nPKT3: CP_DRAW_INDX\n");
	OUT_PKT3(ring, CP_DRAW_INDX, 3);
	OUT_RING(ring, 0x00000000);   /* viz query info. */
	OUT_RING(ring, DRAW(DI_PT_RECTLIST, DI_SRC_SEL_AUTO_INDEX,
			INDEX_SIZE_IGN, IGNORE_VISIBILITY));
	OUT_RING(ring, 0);            /* NumIndices */
	test_go(gpu);
#else
	(void)adreno_gpu;
#endif
}

static int a3xx_hw_init(struct msm_gpu *gpu)
{
	struct adreno_gpu *adreno_gpu = to_adreno_gpu(gpu);
	uint32_t *ptr, len;
	int i, ret;

	DBG("%s", gpu->name);

	if (adreno_is_a305(adreno_gpu)) {
		/* Set up 16 deep read/write request queues: */
		gpu_write(gpu, REG_A3XX_VBIF_IN_RD_LIM_CONF0, 0x10101010);
		gpu_write(gpu, REG_A3XX_VBIF_IN_RD_LIM_CONF1, 0x10101010);
		gpu_write(gpu, REG_A3XX_VBIF_OUT_RD_LIM_CONF0, 0x10101010);
		gpu_write(gpu, REG_A3XX_VBIF_OUT_WR_LIM_CONF0, 0x10101010);
		gpu_write(gpu, REG_A3XX_VBIF_DDR_OUT_MAX_BURST, 0x0000303);
		gpu_write(gpu, REG_A3XX_VBIF_IN_WR_LIM_CONF0, 0x10101010);
		gpu_write(gpu, REG_A3XX_VBIF_IN_WR_LIM_CONF1, 0x10101010);
		/* Enable WR-REQ: */
		gpu_write(gpu, REG_A3XX_VBIF_GATE_OFF_WRREQ_EN, 0x0000ff);
		/* Set up round robin arbitration between both AXI ports: */
		gpu_write(gpu, REG_A3XX_VBIF_ARB_CTL, 0x00000030);
		/* Set up AOOO: */
		gpu_write(gpu, REG_A3XX_VBIF_OUT_AXI_AOOO_EN, 0x0000003c);
		gpu_write(gpu, REG_A3XX_VBIF_OUT_AXI_AOOO, 0x003c003c);

	} else if (adreno_is_a320(adreno_gpu)) {
		/* Set up 16 deep read/write request queues: */
		gpu_write(gpu, REG_A3XX_VBIF_IN_RD_LIM_CONF0, 0x10101010);
		gpu_write(gpu, REG_A3XX_VBIF_IN_RD_LIM_CONF1, 0x10101010);
		gpu_write(gpu, REG_A3XX_VBIF_OUT_RD_LIM_CONF0, 0x10101010);
		gpu_write(gpu, REG_A3XX_VBIF_OUT_WR_LIM_CONF0, 0x10101010);
		gpu_write(gpu, REG_A3XX_VBIF_DDR_OUT_MAX_BURST, 0x0000303);
		gpu_write(gpu, REG_A3XX_VBIF_IN_WR_LIM_CONF0, 0x10101010);
		gpu_write(gpu, REG_A3XX_VBIF_IN_WR_LIM_CONF1, 0x10101010);
		/* Enable WR-REQ: */
		gpu_write(gpu, REG_A3XX_VBIF_GATE_OFF_WRREQ_EN, 0x0000ff);
		/* Set up round robin arbitration between both AXI ports: */
		gpu_write(gpu, REG_A3XX_VBIF_ARB_CTL, 0x00000030);
		/* Set up AOOO: */
		gpu_write(gpu, REG_A3XX_VBIF_OUT_AXI_AOOO_EN, 0x0000003c);
		gpu_write(gpu, REG_A3XX_VBIF_OUT_AXI_AOOO, 0x003c003c);
		/* Enable 1K sort: */
		gpu_write(gpu, REG_A3XX_VBIF_ABIT_SORT, 0x000000ff);
		gpu_write(gpu, REG_A3XX_VBIF_ABIT_SORT_CONF, 0x000000a4);

	} else if (adreno_is_a330(adreno_gpu)) {
		/* Set up 16 deep read/write request queues: */
		gpu_write(gpu, REG_A3XX_VBIF_IN_RD_LIM_CONF0, 0x18181818);
		gpu_write(gpu, REG_A3XX_VBIF_IN_RD_LIM_CONF1, 0x18181818);
		gpu_write(gpu, REG_A3XX_VBIF_OUT_RD_LIM_CONF0, 0x18181818);
		gpu_write(gpu, REG_A3XX_VBIF_OUT_WR_LIM_CONF0, 0x18181818);
		gpu_write(gpu, REG_A3XX_VBIF_DDR_OUT_MAX_BURST, 0x0000303);
		gpu_write(gpu, REG_A3XX_VBIF_IN_WR_LIM_CONF0, 0x18181818);
		gpu_write(gpu, REG_A3XX_VBIF_IN_WR_LIM_CONF1, 0x18181818);
		/* Enable WR-REQ: */
		gpu_write(gpu, REG_A3XX_VBIF_GATE_OFF_WRREQ_EN, 0x00003f);
		/* Set up round robin arbitration between both AXI ports: */
		gpu_write(gpu, REG_A3XX_VBIF_ARB_CTL, 0x00000030);
		/* Set up VBIF_ROUND_ROBIN_QOS_ARB: */
		gpu_write(gpu, REG_A3XX_VBIF_ROUND_ROBIN_QOS_ARB, 0x0001);
		/* Set up AOOO: */
		gpu_write(gpu, REG_A3XX_VBIF_OUT_AXI_AOOO_EN, 0x0000ffff);
		gpu_write(gpu, REG_A3XX_VBIF_OUT_AXI_AOOO, 0xffffffff);
		/* Enable 1K sort: */
		gpu_write(gpu, REG_A3XX_VBIF_ABIT_SORT, 0x0001ffff);
		gpu_write(gpu, REG_A3XX_VBIF_ABIT_SORT_CONF, 0x000000a4);
		/* Disable VBIF clock gating. This is to enable AXI running
		 * higher frequency than GPU:
		 */
		gpu_write(gpu, REG_A3XX_VBIF_CLKON, 0x00000001);

	} else {
		BUG();
	}

	/* Make all blocks contribute to the GPU BUSY perf counter: */
	gpu_write(gpu, REG_A3XX_RBBM_GPU_BUSY_MASKED, 0xffffffff);

	/* Tune the hystersis counters for SP and CP idle detection: */
	gpu_write(gpu, REG_A3XX_RBBM_SP_HYST_CNT, 0x10);
	gpu_write(gpu, REG_A3XX_RBBM_WAIT_IDLE_CLOCKS_CTL, 0x10);

	/* Enable the RBBM error reporting bits.  This lets us get
	 * useful information on failure:
	 */
	gpu_write(gpu, REG_A3XX_RBBM_AHB_CTL0, 0x00000001);

	/* Enable AHB error reporting: */
	gpu_write(gpu, REG_A3XX_RBBM_AHB_CTL1, 0xa6ffffff);

	/* Turn on the power counters: */
	gpu_write(gpu, REG_A3XX_RBBM_RBBM_CTL, 0x00030000);

	/* Turn on hang detection - this spews a lot of useful information
	 * into the RBBM registers on a hang:
	 */
	gpu_write(gpu, REG_A3XX_RBBM_INTERFACE_HANG_INT_CTL, 0x00010fff);

	/* Enable 64-byte cacheline size. HW Default is 32-byte (0x000000E0): */
	gpu_write(gpu, REG_A3XX_UCHE_CACHE_MODE_CONTROL_REG, 0x00000001);

	/* Enable Clock gating: */
	gpu_write(gpu, REG_A3XX_RBBM_CLOCK_CTL, 0xbfffffff);

	/* Set the OCMEM base address for A330 */
//TODO:
//	if (adreno_is_a330(adreno_gpu)) {
//		gpu_write(gpu, REG_A3XX_RB_GMEM_BASE_ADDR,
//			(unsigned int)(a3xx_gpu->ocmem_base >> 14));
//	}

	/* Turn on performance counters: */
	gpu_write(gpu, REG_A3XX_RBBM_PERFCTR_CTL, 0x01);

	/* Set SP perfcounter 7 to count SP_FS_FULL_ALU_INSTRUCTIONS
	 * we will use this to augment our hang detection:
	 */
	gpu_write(gpu, REG_A3XX_SP_PERFCOUNTER7_SELECT,
			SP_FS_FULL_ALU_INSTRUCTIONS);

	gpu_write(gpu, REG_A3XX_RBBM_INT_0_MASK, A3XX_INT0_MASK);

	ret = adreno_hw_init(gpu);
	if (ret)
		return ret;

	/* setup access protection: */
	gpu_write(gpu, REG_A3XX_CP_PROTECT_CTRL, 0x00000007);

	/* RBBM registers */
	gpu_write(gpu, REG_A3XX_CP_PROTECT(0), 0x63000040);
	gpu_write(gpu, REG_A3XX_CP_PROTECT(1), 0x62000080);
	gpu_write(gpu, REG_A3XX_CP_PROTECT(2), 0x600000cc);
	gpu_write(gpu, REG_A3XX_CP_PROTECT(3), 0x60000108);
	gpu_write(gpu, REG_A3XX_CP_PROTECT(4), 0x64000140);
	gpu_write(gpu, REG_A3XX_CP_PROTECT(5), 0x66000400);

	/* CP registers */
	gpu_write(gpu, REG_A3XX_CP_PROTECT(6), 0x65000700);
	gpu_write(gpu, REG_A3XX_CP_PROTECT(7), 0x610007d8);
	gpu_write(gpu, REG_A3XX_CP_PROTECT(8), 0x620007e0);
	gpu_write(gpu, REG_A3XX_CP_PROTECT(9), 0x61001178);
	gpu_write(gpu, REG_A3XX_CP_PROTECT(10), 0x64001180);

	/* RB registers */
	gpu_write(gpu, REG_A3XX_CP_PROTECT(11), 0x60003300);

	/* VBIF registers */
	gpu_write(gpu, REG_A3XX_CP_PROTECT(12), 0x6b00c000);

	/* NOTE: PM4/micro-engine firmware registers look to be the same
	 * for a2xx and a3xx.. we could possibly push that part down to
	 * adreno_gpu base class.  Or push both PM4 and PFP but
	 * parameterize the pfp ucode addr/data registers..
	 */

	/* Load PM4: */
	ptr = (uint32_t *)(adreno_gpu->pm4->data);
	len = adreno_gpu->pm4->size / 4;
	DBG("loading PM4 ucode version: %u", ptr[0]);

	gpu_write(gpu, REG_AXXX_CP_DEBUG,
			AXXX_CP_DEBUG_DYNAMIC_CLK_DISABLE |
			AXXX_CP_DEBUG_MIU_128BIT_WRITE_ENABLE);
	gpu_write(gpu, REG_AXXX_CP_ME_RAM_WADDR, 0);
	for (i = 1; i < len; i++)
		gpu_write(gpu, REG_AXXX_CP_ME_RAM_DATA, ptr[i]);

	/* Load PFP: */
	ptr = (uint32_t *)(adreno_gpu->pfp->data);
	len = adreno_gpu->pfp->size / 4;
	DBG("loading PFP ucode version: %u", ptr[0]);

	gpu_write(gpu, REG_A3XX_CP_PFP_UCODE_ADDR, 0);
	for (i = 1; i < len; i++)
		gpu_write(gpu, REG_A3XX_CP_PFP_UCODE_DATA, ptr[i]);

	/* CP ROQ queue sizes (bytes) - RB:16, ST:16, IB1:32, IB2:64 */
	if (adreno_is_a305(adreno_gpu) || adreno_is_a320(adreno_gpu))
		gpu_write(gpu, REG_AXXX_CP_QUEUE_THRESHOLDS,
				AXXX_CP_QUEUE_THRESHOLDS_CSQ_IB1_START(2) |
				AXXX_CP_QUEUE_THRESHOLDS_CSQ_IB2_START(6) |
				AXXX_CP_QUEUE_THRESHOLDS_CSQ_ST_START(14));


	/* clear ME_HALT to start micro engine */
	gpu_write(gpu, REG_AXXX_CP_ME_CNTL, 0);

	a3xx_me_init(gpu);

	return 0;
}

static void a3xx_destroy(struct msm_gpu *gpu)
{
	struct adreno_gpu *adreno_gpu = to_adreno_gpu(gpu);
	struct a3xx_gpu *a3xx_gpu = to_a3xx_gpu(adreno_gpu);

	DBG("%s", gpu->name);

	adreno_gpu_cleanup(adreno_gpu);
	put_device(&a3xx_gpu->pdev->dev);
	kfree(a3xx_gpu);
}

static void a3xx_idle(struct msm_gpu *gpu)
{
	unsigned long t;

	/* wait for ringbuffer to drain: */
	adreno_idle(gpu);

	t = jiffies + ADRENO_IDLE_TIMEOUT;

	/* then wait for GPU to finish: */
	do {
		uint32_t rbbm_status = gpu_read(gpu, REG_A3XX_RBBM_STATUS);
		if (!(rbbm_status & A3XX_RBBM_STATUS_GPU_BUSY))
			return;
	} while(time_before(jiffies, t));

	DRM_ERROR("timeout waiting for %s to idle!\n", gpu->name);

	/* TODO maybe we need to reset GPU here to recover from hang? */
}

static irqreturn_t a3xx_irq(struct msm_gpu *gpu)
{
	uint32_t status;

	status = gpu_read(gpu, REG_A3XX_RBBM_INT_0_STATUS);
	DBG("%s: %08x", gpu->name, status);

	// TODO

	gpu_write(gpu, REG_A3XX_RBBM_INT_CLEAR_CMD, status);

	msm_gpu_retire(gpu);

	return IRQ_HANDLED;
}

#ifdef CONFIG_DEBUG_FS
static const unsigned int a3xx_registers[] = {
	0x0000, 0x0002, 0x0010, 0x0012, 0x0018, 0x0018, 0x0020, 0x0027,
	0x0029, 0x002b, 0x002e, 0x0033, 0x0040, 0x0042, 0x0050, 0x005c,
	0x0060, 0x006c, 0x0080, 0x0082, 0x0084, 0x0088, 0x0090, 0x00e5,
	0x00ea, 0x00ed, 0x0100, 0x0100, 0x0110, 0x0123, 0x01c0, 0x01c1,
	0x01c3, 0x01c5, 0x01c7, 0x01c7, 0x01d5, 0x01d9, 0x01dc, 0x01dd,
	0x01ea, 0x01ea, 0x01ee, 0x01f1, 0x01f5, 0x01f5, 0x01fc, 0x01ff,
	0x0440, 0x0440, 0x0443, 0x0443, 0x0445, 0x0445, 0x044d, 0x044f,
	0x0452, 0x0452, 0x0454, 0x046f, 0x047c, 0x047c, 0x047f, 0x047f,
	0x0578, 0x057f, 0x0600, 0x0602, 0x0605, 0x0607, 0x060a, 0x060e,
	0x0612, 0x0614, 0x0c01, 0x0c02, 0x0c06, 0x0c1d, 0x0c3d, 0x0c3f,
	0x0c48, 0x0c4b, 0x0c80, 0x0c80, 0x0c88, 0x0c8b, 0x0ca0, 0x0cb7,
	0x0cc0, 0x0cc1, 0x0cc6, 0x0cc7, 0x0ce4, 0x0ce5, 0x0e00, 0x0e05,
	0x0e0c, 0x0e0c, 0x0e22, 0x0e23, 0x0e41, 0x0e45, 0x0e64, 0x0e65,
	0x0e80, 0x0e82, 0x0e84, 0x0e89, 0x0ea0, 0x0ea1, 0x0ea4, 0x0ea7,
	0x0ec4, 0x0ecb, 0x0ee0, 0x0ee0, 0x0f00, 0x0f01, 0x0f03, 0x0f09,
	0x2040, 0x2040, 0x2044, 0x2044, 0x2048, 0x204d, 0x2068, 0x2069,
	0x206c, 0x206d, 0x2070, 0x2070, 0x2072, 0x2072, 0x2074, 0x2075,
	0x2079, 0x207a, 0x20c0, 0x20d3, 0x20e4, 0x20ef, 0x2100, 0x2109,
	0x210c, 0x210c, 0x210e, 0x210e, 0x2110, 0x2111, 0x2114, 0x2115,
	0x21e4, 0x21e4, 0x21ea, 0x21ea, 0x21ec, 0x21ed, 0x21f0, 0x21f0,
	0x2200, 0x2212, 0x2214, 0x2217, 0x221a, 0x221a, 0x2240, 0x227e,
	0x2280, 0x228b, 0x22c0, 0x22c0, 0x22c4, 0x22ce, 0x22d0, 0x22d8,
	0x22df, 0x22e6, 0x22e8, 0x22e9, 0x22ec, 0x22ec, 0x22f0, 0x22f7,
	0x22ff, 0x22ff, 0x2340, 0x2343, 0x2348, 0x2349, 0x2350, 0x2356,
	0x2360, 0x2360, 0x2440, 0x2440, 0x2444, 0x2444, 0x2448, 0x244d,
	0x2468, 0x2469, 0x246c, 0x246d, 0x2470, 0x2470, 0x2472, 0x2472,
	0x2474, 0x2475, 0x2479, 0x247a, 0x24c0, 0x24d3, 0x24e4, 0x24ef,
	0x2500, 0x2509, 0x250c, 0x250c, 0x250e, 0x250e, 0x2510, 0x2511,
	0x2514, 0x2515, 0x25e4, 0x25e4, 0x25ea, 0x25ea, 0x25ec, 0x25ed,
	0x25f0, 0x25f0, 0x2600, 0x2612, 0x2614, 0x2617, 0x261a, 0x261a,
	0x2640, 0x267e, 0x2680, 0x268b, 0x26c0, 0x26c0, 0x26c4, 0x26ce,
	0x26d0, 0x26d8, 0x26df, 0x26e6, 0x26e8, 0x26e9, 0x26ec, 0x26ec,
	0x26f0, 0x26f7, 0x26ff, 0x26ff, 0x2740, 0x2743, 0x2748, 0x2749,
	0x2750, 0x2756, 0x2760, 0x2760, 0x300c, 0x300e, 0x301c, 0x301d,
	0x302a, 0x302a, 0x302c, 0x302d, 0x3030, 0x3031, 0x3034, 0x3036,
	0x303c, 0x303c, 0x305e, 0x305f,
};

static void a3xx_show(struct msm_gpu *gpu, struct seq_file *m)
{
	int i;

	adreno_show(gpu, m);
	seq_printf(m, "status:   %08x\n",
			gpu_read(gpu, REG_A3XX_RBBM_STATUS));

	/* dump these out in a form that can be parsed by demsm: */
	seq_printf(m, "IO:region %s 00000000 00020000\n", gpu->name);
	for (i = 0; i < ARRAY_SIZE(a3xx_registers); i += 2) {
		uint32_t start = a3xx_registers[i];
		uint32_t end   = a3xx_registers[i+1];
		uint32_t addr;

		for (addr = start; addr <= end; addr++) {
			uint32_t val = gpu_read(gpu, addr);
			seq_printf(m, "IO:R %08x %08x\n", addr<<2, val);
		}
	}
}
#endif

static const struct adreno_gpu_funcs funcs = {
	.base = {
		.get_param = adreno_get_param,
		.hw_init = a3xx_hw_init,
		.pm_suspend = msm_gpu_pm_suspend,
		.pm_resume = msm_gpu_pm_resume,
		.recover = adreno_recover,
		.last_fence = adreno_last_fence,
		.submit = adreno_submit,
		.flush = adreno_flush,
		.idle = a3xx_idle,
		.irq = a3xx_irq,
		.destroy = a3xx_destroy,
#ifdef CONFIG_DEBUG_FS
		.show = a3xx_show,
#endif
	},
};

struct msm_gpu *a3xx_gpu_init(struct drm_device *dev)
{
	struct a3xx_gpu *a3xx_gpu = NULL;
	struct msm_gpu *gpu;
	struct platform_device *pdev = a3xx_pdev;
	struct adreno_platform_config *config;
	int ret;

	if (!pdev) {
		dev_err(dev->dev, "no a3xx device\n");
		ret = -ENXIO;
		goto fail;
	}

	config = pdev->dev.platform_data;

	a3xx_gpu = kzalloc(sizeof(*a3xx_gpu), GFP_KERNEL);
	if (!a3xx_gpu) {
		ret = -ENOMEM;
		goto fail;
	}

	gpu = &a3xx_gpu->base.base;

	get_device(&pdev->dev);
	a3xx_gpu->pdev = pdev;

	gpu->fast_rate = config->fast_rate;
	gpu->slow_rate = config->slow_rate;
	gpu->bus_freq  = config->bus_freq;

	DBG("fast_rate=%u, slow_rate=%u, bus_freq=%u",
			gpu->fast_rate, gpu->slow_rate, gpu->bus_freq);

	ret = adreno_gpu_init(dev, pdev, &a3xx_gpu->base,
			&funcs, config->rev);
	if (ret)
		goto fail;

	return &a3xx_gpu->base.base;

fail:
	if (a3xx_gpu)
		a3xx_destroy(&a3xx_gpu->base.base);

	return ERR_PTR(ret);
}

/*
 * The a3xx device:
 */

static int a3xx_probe(struct platform_device *pdev)
{
	static struct adreno_platform_config config = {};
#ifdef CONFIG_OF
	/* TODO */
#else
	uint32_t version = socinfo_get_version();
	if (cpu_is_apq8064ab()) {
		config.fast_rate = 450000000;
		config.slow_rate = 27000000;
		config.bus_freq  = 4;
		config.rev = ADRENO_REV(3, 2, 1, 0);
	} else if (cpu_is_apq8064() || cpu_is_msm8960ab()) {
		config.fast_rate = 400000000;
		config.slow_rate = 27000000;
		config.bus_freq  = 4;

		if (SOCINFO_VERSION_MAJOR(version) == 2)
			config.rev = ADRENO_REV(3, 2, 0, 2);
		else if ((SOCINFO_VERSION_MAJOR(version) == 1) &&
				(SOCINFO_VERSION_MINOR(version) == 1))
			config.rev = ADRENO_REV(3, 2, 0, 1);
		else
			config.rev = ADRENO_REV(3, 2, 0, 0);

	} else if (cpu_is_msm8930()) {
		config.fast_rate = 400000000;
		config.slow_rate = 27000000;
		config.bus_freq  = 3;

		if ((SOCINFO_VERSION_MAJOR(version) == 1) &&
			(SOCINFO_VERSION_MINOR(version) == 2))
			config.rev = ADRENO_REV(3, 0, 5, 2);
		else
			config.rev = ADRENO_REV(3, 0, 5, 0);

	}
#endif
	pdev->dev.platform_data = &config;
	a3xx_pdev = pdev;
	return 0;
}

static int a3xx_remove(struct platform_device *pdev)
{
	a3xx_pdev = NULL;
	return 0;
}

static struct platform_driver a3xx_driver = {
	.probe = a3xx_probe,
	.remove = a3xx_remove,
	.driver.name = "kgsl-3d0",
};

void __init a3xx_register(void)
{
	platform_driver_register(&a3xx_driver);
}

void __exit a3xx_unregister(void)
{
	platform_driver_unregister(&a3xx_driver);
}
